version: '3.8'

# Note: Project name is set via COMPOSE_PROJECT_NAME in Makefile
# to ensure consistent container naming across docker-compose versions

services:
  # Server node 1 - isolated data directory
  server1:
    image: benchfs:latest  # Use pre-built optimized image
    container_name: benchfs_server1
    hostname: server1
    networks:
      benchfs_net:
        ipv4_address: 172.20.0.11
    volumes:
      - shared_registry:/shared/registry:rw  # Shared registry for service discovery
      - server1_data:/shared/data:rw         # Isolated data directory
      - ../../target/release/benchfsd_mpi:/usr/local/bin/benchfsd_mpi:ro
      - ./scripts:/scripts:ro
      - ./configs:/configs:ro                # Config files
    environment:
      - RUST_LOG=trace  # Use trace level to see timer reactor details
      - RUST_BACKTRACE=full  # Enable full backtrace for panics
      - UCX_TLS=tcp,self  # Disable 'sm' (shared memory) for Docker stability
      - UCX_LOG_LEVEL=info  # Enable UCX logging for debugging
      - OMPI_ALLOW_RUN_AS_ROOT=1
      - OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
      - BENCHFS_OPERATION_TIMEOUT=30  # 30-second timeout for operations
    cap_add:
      - SYS_PTRACE
      - IPC_LOCK
      - SYS_RESOURCE  # Required for io_uring
      - SYS_ADMIN     # Required for io_uring setup
    security_opt:
      - seccomp:unconfined  # Allow io_uring syscalls
    deploy:
      resources:
        limits:
          memory: 32G  # Reduced from 64G (queue_size reduction allows smaller memory limit)
        reservations:
          memory: 4G
    command: /usr/sbin/sshd -D

  # Server node 2 - isolated data directory
  server2:
    image: benchfs:latest  # Use pre-built optimized image
    container_name: benchfs_server2
    hostname: server2
    networks:
      benchfs_net:
        ipv4_address: 172.20.0.12
    volumes:
      - shared_registry:/shared/registry:rw  # Shared registry for service discovery
      - server2_data:/shared/data:rw         # Isolated data directory
      - ../../target/release/benchfsd_mpi:/usr/local/bin/benchfsd_mpi:ro
      - ./scripts:/scripts:ro
      - ./configs:/configs:ro                # Config files
    environment:
      - RUST_LOG=trace  # Use trace level to see timer reactor details
      - RUST_BACKTRACE=full  # Enable full backtrace for panics
      - UCX_TLS=tcp,self  # Disable 'sm' (shared memory) for Docker stability
      - UCX_LOG_LEVEL=info  # Enable UCX logging for debugging
      - OMPI_ALLOW_RUN_AS_ROOT=1
      - OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
      - BENCHFS_OPERATION_TIMEOUT=30  # 30-second timeout for operations
    cap_add:
      - SYS_PTRACE
      - IPC_LOCK
      - SYS_RESOURCE  # Required for io_uring
      - SYS_ADMIN     # Required for io_uring setup
    security_opt:
      - seccomp:unconfined  # Allow io_uring syscalls
    deploy:
      resources:
        limits:
          memory: 32G  # Reduced from 64G (queue_size reduction allows smaller memory limit)
        reservations:
          memory: 4G
    command: /usr/sbin/sshd -D

  # Server node 3 - isolated data directory
  server3:
    image: benchfs:latest  # Use pre-built optimized image
    container_name: benchfs_server3
    hostname: server3
    networks:
      benchfs_net:
        ipv4_address: 172.20.0.13
    volumes:
      - shared_registry:/shared/registry:rw  # Shared registry for service discovery
      - server3_data:/shared/data:rw         # Isolated data directory
      - ../../target/release/benchfsd_mpi:/usr/local/bin/benchfsd_mpi:ro
      - ./scripts:/scripts:ro
      - ./configs:/configs:ro                # Config files
    environment:
      - RUST_LOG=trace  # Use trace level to see timer reactor details
      - RUST_BACKTRACE=full  # Enable full backtrace for panics
      - UCX_TLS=tcp,self  # Disable 'sm' (shared memory) for Docker stability
      - UCX_LOG_LEVEL=info  # Enable UCX logging for debugging
      - OMPI_ALLOW_RUN_AS_ROOT=1
      - OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
      - BENCHFS_OPERATION_TIMEOUT=30  # 30-second timeout for operations
    cap_add:
      - SYS_PTRACE
      - IPC_LOCK
      - SYS_RESOURCE  # Required for io_uring
      - SYS_ADMIN     # Required for io_uring setup
    security_opt:
      - seccomp:unconfined  # Allow io_uring syscalls
    deploy:
      resources:
        limits:
          memory: 32G  # Reduced from 64G (queue_size reduction allows smaller memory limit)
        reservations:
          memory: 4G
    command: /usr/sbin/sshd -D

  # Server node 4 - isolated data directory
  server4:
    image: benchfs:latest  # Use pre-built optimized image
    container_name: benchfs_server4
    hostname: server4
    networks:
      benchfs_net:
        ipv4_address: 172.20.0.14
    volumes:
      - shared_registry:/shared/registry:rw  # Shared registry for service discovery
      - server4_data:/shared/data:rw         # Isolated data directory
      - ../../target/release/benchfsd_mpi:/usr/local/bin/benchfsd_mpi:ro
      - ./scripts:/scripts:ro
      - ./configs:/configs:ro                # Config files
    environment:
      - RUST_LOG=trace  # Use trace level to see timer reactor details
      - RUST_BACKTRACE=full  # Enable full backtrace for panics
      - UCX_TLS=tcp,self  # Disable 'sm' (shared memory) for Docker stability
      - UCX_LOG_LEVEL=info  # Enable UCX logging for debugging
      - OMPI_ALLOW_RUN_AS_ROOT=1
      - OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
      - BENCHFS_OPERATION_TIMEOUT=30  # 30-second timeout for operations
    cap_add:
      - SYS_PTRACE
      - IPC_LOCK
      - SYS_RESOURCE  # Required for io_uring
      - SYS_ADMIN     # Required for io_uring setup
    security_opt:
      - seccomp:unconfined  # Allow io_uring syscalls
    deploy:
      resources:
        limits:
          memory: 32G  # Reduced from 64G (queue_size reduction allows smaller memory limit)
        reservations:
          memory: 4G
    command: /usr/sbin/sshd -D

  # MPI controller node
  controller:
    image: benchfs:latest  # Use pre-built optimized image
    container_name: benchfs_controller
    hostname: controller
    networks:
      benchfs_net:
        ipv4_address: 172.20.0.10
    volumes:
      - shared_registry:/shared/registry:rw   # Shared registry
      - controller_results:/shared/results:rw # Results directory
      - ../../target/release/benchfsd_mpi:/usr/local/bin/benchfsd_mpi:ro
      - ./scripts:/scripts:ro
      - ./configs:/configs:ro
    environment:
      - RUST_LOG=trace  # Use trace level to see timer reactor details
      - RUST_BACKTRACE=full  # Enable full backtrace for panics
      - UCX_TLS=tcp,self  # Disable 'sm' (shared memory) for Docker stability
      - UCX_LOG_LEVEL=info  # Enable UCX logging for debugging
      - OMPI_ALLOW_RUN_AS_ROOT=1
      - OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
      - BENCHFS_OPERATION_TIMEOUT=30  # 30-second timeout for operations
    depends_on:
      - server1
      - server2
      - server3
      - server4
    cap_add:
      - SYS_PTRACE
      - IPC_LOCK
      - SYS_RESOURCE  # Required for io_uring
      - SYS_ADMIN     # Required for io_uring setup
    security_opt:
      - seccomp:unconfined  # Allow io_uring syscalls
    deploy:
      resources:
        limits:
          memory: 8G  # Controller needs less memory than servers
        reservations:
          memory: 2G
    command: /usr/sbin/sshd -D

volumes:
  # Shared registry for service discovery (all nodes need access)
  shared_registry:
    driver: local

  # Isolated data volumes per server (simulating separate file systems)
  server1_data:
    driver: local
  server2_data:
    driver: local
  server3_data:
    driver: local
  server4_data:
    driver: local

  # Results directory for controller
  controller_results:
    driver: local

networks:
  benchfs_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
