# Simplified BenchFS Docker Image for Local Testing
# Uses pre-built binaries from host

FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# Install runtime dependencies and IOR build dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    wget \
    openssh-server \
    autoconf \
    automake \
    libtool \
    pkg-config \
    git \
    && rm -rf /var/lib/apt/lists/*

# Install UCX
WORKDIR /tmp
RUN wget https://github.com/openucx/ucx/releases/download/v1.18.0/ucx-1.18.0.tar.gz && \
    tar xzf ucx-1.18.0.tar.gz && \
    cd ucx-1.18.0 && \
    ./configure --prefix=/usr/local \
                --enable-mt \
                --disable-numa \
                --without-verbs \
                --without-rocm \
                --without-cuda && \
    make -j$(nproc) && \
    make install && \
    ldconfig && \
    cd .. && \
    rm -rf ucx-1.15.0*

# Install OpenMPI
RUN wget https://download.open-mpi.org/release/open-mpi/v4.1/openmpi-4.1.5.tar.gz && \
    tar xzf openmpi-4.1.5.tar.gz && \
    cd openmpi-4.1.5 && \
    ./configure --prefix=/usr/local \
                --with-ucx=/usr/local \
                --enable-mpi-cxx && \
    make -j$(nproc) && \
    make install && \
    ldconfig && \
    cd .. && \
    rm -rf openmpi-4.1.5*

# Build IOR
RUN git clone https://github.com/hpc/ior.git && \
    cd ior && \
    git checkout 3.3.0 && \
    ./bootstrap && \
    ./configure --prefix=/usr/local \
                --with-mpiio && \
    make -j$(nproc) && \
    make install && \
    cd .. && \
    rm -rf ior

# Setup SSH for MPI
RUN mkdir /var/run/sshd && \
    ssh-keygen -A && \
    mkdir -p /root/.ssh && \
    ssh-keygen -t rsa -N "" -f /root/.ssh/id_rsa && \
    cat /root/.ssh/id_rsa.pub >> /root/.ssh/authorized_keys && \
    chmod 600 /root/.ssh/authorized_keys && \
    echo "StrictHostKeyChecking no" >> /etc/ssh/ssh_config && \
    echo "UserKnownHostsFile=/dev/null" >> /etc/ssh/ssh_config

# Create directories
RUN mkdir -p /shared/registry /shared/data /logs

# Environment variables
ENV UCX_TLS=tcp,sm,self
ENV OMPI_ALLOW_RUN_AS_ROOT=1
ENV OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1
ENV LD_LIBRARY_PATH=/usr/local/lib:${LD_LIBRARY_PATH}

WORKDIR /workspace

# Expose SSH port
EXPOSE 22

CMD ["/usr/sbin/sshd", "-D"]
