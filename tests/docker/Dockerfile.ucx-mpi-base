# UCX and OpenMPI Base Image
# This image contains pre-built UCX and OpenMPI libraries
# Build once and reuse for multiple BenchFS builds
#
# Build command:
#   docker build -f Dockerfile.ucx-mpi-base -t benchfs/ucx-mpi-base:1.0 .
#
# Push to registry (optional):
#   docker tag benchfs/ucx-mpi-base:1.0 your-registry/benchfs/ucx-mpi-base:1.0
#   docker push your-registry/benchfs/ucx-mpi-base:1.0

FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# Install build dependencies and runtime dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    git \
    pkg-config \
    libssl-dev \
    cmake \
    autoconf \
    automake \
    libtool \
    wget \
    ca-certificates \
    # Runtime dependencies
    libssl3 \
    openssh-server \
    && rm -rf /var/lib/apt/lists/*

# Install UCX (Unified Communication X)
WORKDIR /tmp
RUN wget https://github.com/openucx/ucx/releases/download/v1.18.0/ucx-1.18.0.tar.gz && \
    tar xzf ucx-1.18.0.tar.gz && \
    cd ucx-1.18.0 && \
    ./configure --prefix=/usr/local \
                --enable-mt \
                --disable-numa \
                --without-verbs \
                --without-rocm \
                --without-cuda && \
    make -j$(nproc) && \
    make install && \
    ldconfig && \
    cd .. && \
    rm -rf ucx-1.18.0*

# Install OpenMPI
RUN wget https://download.open-mpi.org/release/open-mpi/v4.1/openmpi-4.1.5.tar.gz && \
    tar xzf openmpi-4.1.5.tar.gz && \
    cd openmpi-4.1.5 && \
    ./configure --prefix=/usr/local \
                --with-ucx=/usr/local \
                --enable-mpi-cxx && \
    make -j$(nproc) && \
    make install && \
    ldconfig && \
    cd .. && \
    rm -rf openmpi-4.1.5*

# Setup SSH for MPI
RUN mkdir /var/run/sshd && \
    ssh-keygen -A && \
    mkdir -p /root/.ssh && \
    ssh-keygen -t rsa -N "" -f /root/.ssh/id_rsa && \
    cat /root/.ssh/id_rsa.pub >> /root/.ssh/authorized_keys && \
    chmod 600 /root/.ssh/authorized_keys && \
    echo "StrictHostKeyChecking no" >> /etc/ssh/ssh_config && \
    echo "UserKnownHostsFile=/dev/null" >> /etc/ssh/ssh_config

# Create directories
RUN mkdir -p /shared/registry /shared/data /logs

WORKDIR /workspace

# Expose SSH port
EXPOSE 22

CMD ["/usr/sbin/sshd", "-D"]
