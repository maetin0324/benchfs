# 未実装機能と実装計画

**日付**: 2025-10-18
**フェーズ**: Phase 10 - 未実装機能の完成

## 実施した調査

リポジトリ全体を徹底的に調査し、未実装・不完全な機能を特定しました。

---

## 未実装・不完全機能の包括的リスト

### 🔴 高優先度（機能完全性に必須）

#### 1. データ永続化保証の欠如
- **ファイル**: `src/storage/iouring.rs:345-352`
- **問題**: `fsync()`が未実装
- **ステータス**: ✅ pluvio側で実装済み（使用を開始）
- **影響**: クラッシュ時のデータ損失リスク、データ整合性の保証なし

#### 2. RPCエラーハンドリングの不備
- **ファイル**: `src/rpc/server.rs:176-182`
- **問題**: ハンドラエラー時にクライアントへ適切なエラー応答を返せない
- **影響**: クライアントがタイムアウトまで待機する必要がある
- **実装予定**: Phase 1

#### 3. RPC応答受信の未完全実装
- **ファイル**: `src/rpc/client.rs:80`
- **問題**: レスポンス受信処理が簡易実装（TODO コメントあり）
- **影響**: タイムアウト処理やエラーハンドリングが不十分
- **実装予定**: Phase 1

#### 4. RDMA プロトコル指定の制限
- **ファイル**: `src/rpc/client.rs:50, 113`
- **問題**: pluvio_ucxが`AmProto`をエクスポートしていない
- **影響**: RDMA Rendezvousプロトコルの最適化が制限される
- **実装予定**: pluvio_ucx側の対応待ち

#### 5. 基本的なPOSIX操作の欠落
- **ファイル**: `src/api/file_ops.rs`
- **未実装の操作**:
  - `rename()` - ファイル/ディレクトリのリネーム
  - `stat()` - ファイル属性の取得
  - `chmod()` / `chown()` - パーミッション/所有者変更
  - `link()` / `symlink()` - ハードリンク/シンボリックリンク
  - `readdir()` の公開API化
  - `truncate()` の個別関数化
- **実装予定**: Phase 1

---

### 🟡 中優先度（品質・信頼性向上）

#### 6. ストレージ最適化機能の無効化
- **ファイル**: `src/storage/iouring.rs:58-62`
- **問題**: O_DIRECTフラグがテストのために無効化されている
- **影響**: 本番環境でのページキャッシュバイパスができない
- **実装予定**: Phase 2

#### 7. テストカバレッジの不足
- **ファイル**: `src/rpc/connection.rs:182-186`
- **問題**: UCXを必要とする接続プールテストが`#[ignore]`
- 統合テストがない
- パフォーマンステスト/ベンチマークがない
- 負荷テスト（大規模データ、多数接続）がない
- 障害テスト（ネットワーク/ノード障害）がない
- **実装予定**: Phase 2

#### 8. メトリクスと監視機能の欠落
- RPCレイテンシ測定
- スループット統計
- I/O操作カウンター
- エラー率トラッキング
- リソース使用率（CPU、メモリ、ネットワーク）
- **実装予定**: Phase 2

#### 9. ネットワーク信頼性機能の欠如
- 自動再接続（ネットワーク障害時のリトライなし）
- ノードヘルスチェック（死活監視なし）
- コネクション再利用の最適化不足
- **実装予定**: Phase 2

#### 10. server_handlerの未使用
- **ファイル**: `src/rpc/data_ops.rs`, `src/rpc/metadata_ops.rs`
- **問題**: `AmRpc`トレイトの`server_handler`メソッドが全てエラーを返すプレースホルダー
- **実装予定**: Phase 3（リファクタリング時）

---

### 🟢 低優先度（将来的な機能拡張）

#### 11. メタデータレプリケーションの未実装
- **ファイル**: `src/metadata/manager.rs:109-125`
- **問題**: レプリケーション用メソッドは存在するが、実際のレプリケーションロジックが未実装
- **実装予定**: Phase 4

#### 12. データ配置戦略の未完成
- **ファイル**: `src/data/placement.rs`
- 動的なノード追加/削除時のリバランシング
- レプリケーションの自動配置
- 負荷に基づく動的配置変更
- **実装予定**: Phase 4

#### 13. キャッシュ最適化機能
- **ファイル**: `src/cache/chunk_cache.rs`
- プリフェッチ機能
- Write-backキャッシュ（現在はWrite-throughのみ）
- 適応的なTTL調整
- キャッシュヒット率の記録
- **実装予定**: Phase 3-4

#### 14. RDMA最適化の未完成
- RDMA閾値による自動RPC/RDMA切り替えロジックが未実装（設定は存在）
- 完全なゼロコピー転送パスが未完成
- **実装予定**: Phase 3

#### 15. ドキュメントで言及されているが未実装の機能
- 設定バリデーション強化
- クライアントライブラリの充実
- 2層ストレージバックエンド（InMemory + File自動階層化）
- クライアント側バッファリング
- メタデータキャッシュTTL完全実装
- FUSE統合（chfuse相当）
- **実装予定**: Phase 3-4

---

## 実装計画

### Phase 1: 基本機能の完成（高優先度） ← **現在実施中**

#### 1.1 fsync実装の確認と統合
- ✅ pluvio側で実装済み
- IOURingStorageでfsyncを使用

#### 1.2 RPCエラーハンドリングの改善
- サーバー側でエラーレスポンスを正しく返す
- クライアント側でエラーを適切に処理
- タイムアウト処理の実装

#### 1.3 基本POSIX操作の実装
- `benchfs_rename()` - ファイル/ディレクトリのリネーム
- `benchfs_stat()` - ファイル属性の取得
- `benchfs_readdir()` - ディレクトリ一覧の公開API化
- `benchfs_truncate()` - ファイルサイズ変更
- `benchfs_fsync()` - データ同期

優先度低め（Phase 1.5または2）:
- `benchfs_chmod()` / `benchfs_chown()` - パーミッション/所有者変更
- `benchfs_link()` / `benchfs_symlink()` - ハードリンク/シンボリックリンク

#### 1.4 RDMA自動切り替えロジックの検討
- 現在の実装状況を確認
- pluvio_ucxの対応状況を確認
- 可能な範囲で実装

---

### Phase 2: 品質向上（中優先度）
- 統合テスト・負荷テストの追加
- メトリクス収集システムの実装
- 自動再接続とヘルスチェック
- O_DIRECTサポートの有効化

---

### Phase 3: 本番運用対応
- キャッシュ最適化（プリフェッチ、Write-back）
- エラーハンドリングの包括的改善
- ドキュメントの充実
- RDMA最適化の完成

---

### Phase 4: 機能拡張
- メタデータレプリケーション
- 2層ストレージ自動階層化
- FUSE統合

---

## プロジェクト完成度評価

- **コア機能**: 85%完成（基本的なファイルシステム操作は動作）
- **本番環境対応**: 60%完成（データ永続化保証、エラーハンドリングに課題）
- **テスト品質**: 50%完成（単体テストは充実、統合/負荷テストが不足）
- **観測可能性**: 30%完成（ログはあるがメトリクスなし）
- **フォールトトレランス**: 40%完成（レプリケーション未実装）

**総合完成度**: 約**70-75%**

---

## 次のステップ

1. ✅ このドキュメントの作成
2. Phase 1.1: fsync実装の確認と統合
3. Phase 1.2: RPCエラーハンドリングの改善
4. Phase 1.3: 基本POSIX操作の実装
5. Phase 1.4: RDMA自動切り替えロジックの検討

Phase 1完了後にPhase 2へ進む。
